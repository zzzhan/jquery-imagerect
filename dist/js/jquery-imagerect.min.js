/*! jquery-imagerect 2015-09-16 */
!function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery"],a):window.jQuery&&a(window.jQuery)}(function(a){var b={},c=function(c,d){this.element=c;var e=a(this.element);this.opts=a.extend({},b,e.data(),d),this.opts.url&&this.load(this.opts.url)},d=function(a){return{w:a.width/2,h:a.height/2,x:0,y:0}};c.version="0.1.1",c.prototype={constructor:c,_loaded:function(b){var c=a(this.element);c.text("");var e=b.target;this.opts.url=e.src,c.css({background:"url("+e.src+") no-repeat"}),this.opts.w=this.opts.w||c.width(),this.opts.h=this.opts.h||c.height(),this.opts.w<e.width&&(c.css("background-size","100% auto"),c.css("filter","progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+this.opts.url+"', sizingMethod='scale')\\9")),this.percent=this.opts.w/e.width;var f=this.opts.rect||d(e),g=e.height*this.percent;c.height(Math.max(this.opts.h,g)),0===a(".imagerect-selector",c).length&&a('<div class="imagerect-selector"></div>').appendTo(c).on("dblclick",a.proxy(this.dblclick,this)).on("mousedown",a.proxy(this.mousedown,this)).on("mouseup",a.proxy(this.mouseup,this)).css("resize",this.opts.resize||"both"),this.rect(f),c.trigger("loaded",[this.rect(),e]),this.img=e},load:function(b,c){var d=a(this.element);a(".imagerect-selector",d).remove(),this.opts.rect=c;var e=new Image;e.src=b,a(e).on("load",a.proxy(this._loaded,this)).on("error",function(){d.text("Load image error.")}),d.text("Loading...")},mousedown:function(b){var c=a(this.element),d=a(".imagerect-selector",c);b.stopPropagation();var e=b.originalEvent,f=d.width(),g=d.height();this.sw=f,this.sh=g,this.offsetDx=e.clientX-c.offset().left,this.offsetDy=e.clientY-c.offset().top,d.on("mousemove",a.proxy(this.mousemove,this))},mousemove:function(b){var c=a(this.element),d=a(".imagerect-selector",c);b.stopPropagation();var e=b.originalEvent,f=d.width(),g=d.height();this.sw===f&&this.sh===g&&(this.offsetMx=e.clientX-c.offset().left,this.offsetMy=e.clientY-c.offset().top,this.move(),this.offsetDx=this.offsetMx,this.offsetDy=this.offsetMy)},mouseup:function(){var b=a(this.element),c=a(".imagerect-selector",b);c.off("mousemove");var d=this.percent,e=this.currOffset(),f=c.innerWidth(),g=c.innerHeight();a.extend(this.opts.rect,{x:e.left/d,y:e.top/d,w:f/d,h:g/d}),b.trigger("rect",[this.rect()])},move:function(){var b=a(this.element),c=a(".imagerect-selector",b),d=this.offsetMx-this.offsetDx,e=this.offsetMy-this.offsetDy,f=c.offset(),g=f.left,h=f.top;c.offset({top:h+e,left:g+d})},dblclick:function(b){var c=a(this.element),e=this.img;if(b.stopPropagation(),b.preventDefault(),this.opts.dblToggle){this.opts.dblToggle=!1;var f=this.lastRect||d(e);console.log(f),c.trigger("rect",[this.rect({x:f.x,y:f.y,w:f.w,h:f.h})])}else this.opts.dblToggle=!0,this.lastRect=this.rect(),c.trigger("rect",[this.rect({x:0,y:0,w:e.width,h:e.height})])},currOffset:function(){var b=a(this.element),c=a(".imagerect-selector",b),d=c.offset(),e=b.offset(),f=(c.outerWidth(!0)-c.innerWidth())/2,g=(c.outerHeight(!0)-c.innerHeight())/2,h=d.left-e.left+f,i=d.top-e.top+g;return{left:h,top:i}},rect:function(b){var c=this.percent;if(b){var d=a(this.element),e=a(".imagerect-selector",d);b=a.extend({},this.opts.rect,b);var f=b.x*c,g=b.y*c,h=b.w*c,i=b.h*c,j=this.currOffset();this.offsetMx=f,this.offsetMy=g,this.offsetDx=j.left,this.offsetDy=j.top,this.move(),e.width(h),e.height(i),this.opts.rect=b}return this.opts.rect}},a.imagerect=c,a.fn.imagerect=function(b){var d=arguments,e=null;return this.each(function(){var f=a(this),g=f.data("imagerect"),h="object"==typeof b?b:{};g||"string"==typeof b?"string"==typeof b&&(e=g[b].apply(g,Array.prototype.slice.call(d,1))):f.data("imagerect",new c(this,h))}),e||this},a.fn.imagerect.constructor=c});