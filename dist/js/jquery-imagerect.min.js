/*! jquery-imagerect 2015-04-29 */
!function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery"],a):window.jQuery&&a(window.jQuery)}(function(a){var b={},c=function(c,d){this.elm=a(c),this.option(a.extend({},b,this.elm.data(),d))};c.version="0.1.1",c.prototype={constructor:c,imageload:function(){this.elm.text(""),this.url(this.opts.url),this.opts.w=this.opts.w||this.elm.width(),this.opts.h=this.opts.h||this.elm.height(),this.opts.w<this.img.width&&(this.elm.css("background-size","100% auto"),this.elm.css("filter","progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+this.opts.url+"', sizingMethod='scale')\\9")),this.percent=this.opts.w/this.img.width;var b=this.opts.rect||this.defRect(),c=this.img.height*this.percent;this.elm.height(Math.max(this.opts.h,c)),null==this.selector&&(this.selector=a('<div class="imagerect-selector"></div>').appendTo(this.elm),this.selector.on("dblclick",a.proxy(this.dblclick,this)),this.selector.on("mousedown",a.proxy(this.mousedown,this)),this.selector.on("mouseup",a.proxy(this.mouseup,this)),this.selector.css("resize",this.opts.resize||"both")),this.rect(b),this.elm.trigger({type:"load",value:this.rect(),relatedTarget:this.img})},defRect:function(){return{w:this.img.width/2,h:this.img.height/2,x:this.img.width/4,y:this.img.height/4}},url:function(a){return a&&this.elm.css({background:"url("+a+") no-repeat"}),this.opts.url},option:function(b){if(b){if(b.url){var c=new Image;c.src=b.url,a(c).on("load",a.proxy(this.imageload,this)),this.img=c,this.elm.text("loading...")}this.opts=a.extend(this.opts,b)}return this.opts},mousedown:function(b){b.stopPropagation();var c=b.originalEvent,d=this.selector.width(),e=this.selector.height();this.sw=d,this.sh=e,this.offsetDx=c.clientX-this.elm.offset().left,this.offsetDy=c.clientY-this.elm.offset().top,this.selector.on("mousemove",a.proxy(this.mousemove,this))},mousemove:function(a){a.stopPropagation();var b=a.originalEvent,c=this.selector.width(),d=this.selector.height();this.sw===c&&this.sh===d&&(this.offsetMx=b.clientX-this.elm.offset().left,this.offsetMy=b.clientY-this.elm.offset().top,this.move(),this.offsetDx=this.offsetMx,this.offsetDy=this.offsetMy)},mouseup:function(){this.selector.off("mousemove");var b=this.percent,c=this.currOffset(),d=this.selector.innerWidth(),e=this.selector.innerHeight();a.extend(this.opts.rect,{x:c.left/b,y:c.top/b,w:d/b,h:e/b}),this.elm.trigger({type:"pick",value:this.rect()})},move:function(){var a=this.offsetMx-this.offsetDx,b=this.offsetMy-this.offsetDy,c=this.selector.offset(),d=c.left,e=c.top;this.selector.offset({top:e+b,left:d+a})},dblclick:function(a){if(a.stopPropagation(),a.preventDefault(),this.opts.dblToggle){this.opts.dblToggle=!1;var b=this.lastRect||this.defRect();console.log(b),this.elm.trigger({type:"pick",value:this.rect({x:b.x,y:b.y,w:b.w,h:b.h})})}else this.opts.dblToggle=!0,this.lastRect=this.rect(),this.elm.trigger({type:"pick",value:this.rect({x:0,y:0,w:this.img.width,h:this.img.height})})},currOffset:function(){var a=this.selector.offset(),b=this.elm.offset(),c=(this.selector.outerWidth(!0)-this.selector.innerWidth())/2,d=(this.selector.outerHeight(!0)-this.selector.innerHeight())/2,e=a.left-b.left+c,f=a.top-b.top+d;return{left:e,top:f}},rect:function(b){var c=this.percent;if(b){b=a.extend({},this.opts.rect,b);var d=b.x*c,e=b.y*c,f=b.w*c,g=b.h*c,h=this.currOffset();this.offsetMx=d,this.offsetMy=e,this.offsetDx=h.left,this.offsetDy=h.top,this.move(),this.selector.width(f),this.selector.height(g),this.opts.rect=b}return this.opts.rect}},a.imagerect=c,a.fn.imagerect=function(b){var d=arguments,e=null;return this.each(function(){var f=a(this),g=f.data("imagerect"),h="object"==typeof b?b:{};g||"string"==typeof b?"string"==typeof b&&(e=g[b].apply(g,Array.prototype.slice.call(d,1))):f.data("imagerect",new c(this,h))}),e||this},a.fn.imagerect.constructor=c});